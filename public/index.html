<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Zoomable Image with OpenSeadragon</title>
    <link rel="stylesheet" href="./main.css" />
  </head>
  <body>
    <h2>üñºÔ∏è OpenSeadragon Zoomable Image Viewer</h2>
    <div class="input-bar">
      <input
        type="text"
        id="link-input"
        placeholder="Paste a DZI file URL (e.g. https://.../image.dzi)"
      />
      <button id="use-link">Load from link</button>
    </div>
    <div style="text-align:center; color:#888; font-size:0.97em; margin-bottom:8px;">
      Example: <code>https://openseadragon.github.io/example-images/duomo/duomo.dzi</code>
    </div>
    <div class="loader" id="loader"></div>
    <div class="perf-log" id="perf-log"></div>
    <div id="viewer"></div>
    <div style="text-align:center; margin-top: 18px;">
      üëâ <a href="./geo-tiff.html" target="_blank" style="color:#3498db; font-size:1.08em; text-decoration:underline;">
        Try the OpenSeadragon GeoTIFF Demo (Tiff Files)
      </a>
    </div>
    <!-- Include OpenSeadragon library (use 5.0.1 for plugin compatibility) -->
    <script src="./openseadragon.min.js"></script>
    <script>
      let viewerInitStartTime = 0;
      let viewerInstance = null;

      /**
       * Validates if the given URL is a valid DZI image URL.
       * @param {string} url
       * @returns {boolean}
       */
      function isValidDziUrl(url) {
        try {
          const parsed = new URL(url);
          // Must end with .dzi and be http(s)
          return (parsed.protocol === 'http:' || parsed.protocol === 'https:') && /\.dzi(\?.*)?$/i.test(parsed.pathname);
        } catch {
          return false;
        }
      }

      function showInputError(msg) {
        const perfLog = document.getElementById('perf-log');
        perfLog.textContent = msg;
        perfLog.style.color = '#c0392b';
        setTimeout(() => { perfLog.textContent = ''; perfLog.style.color = '#555'; }, 3000);
      }

      function trackPerformance(event, extra = {}) {
        const now = performance.now();
        const data = {
          event,
          timestamp: Date.now(),
          perfNow: now,
          ...extra
        };
        if (event === 'image-opened' && extra.loadTimeSeconds) {
          document.getElementById('perf-log').textContent = `‚è±Ô∏è Loaded in ${extra.loadTimeSeconds} seconds.`;
          document.getElementById('perf-log').style.color = '#555';
          document.getElementById('loader').style.display = 'none';
        } else if (event === 'viewer-init-start') {
          document.getElementById('perf-log').textContent = '';
          document.getElementById('perf-log').style.color = '#555';
          document.getElementById('loader').style.display = 'block';
        } else if (event === 'viewer-init-error') {
          document.getElementById('perf-log').textContent = '‚ùå Failed to load image.';
          document.getElementById('perf-log').style.color = '#c0392b';
          document.getElementById('loader').style.display = 'none';
        }
        console.log('[PERF]', data);
      }

      /**
       * Loads a DZI image into the OpenSeadragon viewer and tracks load performance.
       * Empties the previous viewer instance if present.
       * @param {string|Object} tileSource
       * @param {string} label
       */
      function loadDZI(tileSource, label) {
        // Destroy previous viewer if exists
        if (viewerInstance && typeof viewerInstance.destroy === 'function') {
          viewerInstance.destroy();
        } else if (viewerInstance && typeof viewerInstance.close === 'function') {
          viewerInstance.close();
        }
        document.getElementById('viewer').innerHTML = '';
        viewerInitStartTime = performance.now();
        trackPerformance('viewer-init-start');
        viewerInstance = OpenSeadragon({
          id: "viewer",
          prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/images/",
          tileSources: tileSource,
          showNavigator: true,
          visibilityRatio: 1.0,
          minZoomLevel: 1,
          maxZoomLevel: 20
        });
        viewerInstance.addHandler('open', function() {
          const imageOpenedTime = performance.now();
          const loadTimeSeconds = ((imageOpenedTime - viewerInitStartTime) / 1000).toFixed(3);
          trackPerformance('image-opened', {
            message: 'Image has been loaded and displayed.' + (label ? ' [' + label + ']' : ''),
            loadTimeSeconds: loadTimeSeconds
          });
        });
      }

      window.addEventListener('DOMContentLoaded', () => {
        trackPerformance('dom-content-loaded');
        document.getElementById('use-link').addEventListener('click', function() {
          const url = document.getElementById('link-input').value.trim();
          if (!url) {
            showInputError('Please enter a DZI file URL.');
            return;
          }
          if (!isValidDziUrl(url)) {
            showInputError('Please enter a valid DZI image URL (must end with .dzi and use http/https).');
            return;
          }
          loadDZI(url, url);
        });
        document.getElementById('file-picker').addEventListener('change', function(ev) {
          const file = ev.target.files[0];
          if (!file) return;
          const url = URL.createObjectURL(file);
          loadDZI(url, file.name);
        });
      });

      // load initial DZI image
      loadDZI('https://openseadragon.github.io/example-images/duomo/duomo.dzi', 'Duomo DZI Example');
    </script>
  </body>
</html>
